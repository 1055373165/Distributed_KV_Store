# gRPC 开发流程

## 定义服务
1. 在扩展名为 .proto 的文件中定义 gRPC 服务和方法的请求和响应类型；
2. 使用 protobuf 编译器和 go gRPC 插件从我们的 .proto 服务定义中生成特定语言的代码，比如 go 语言；这将在指定的文件夹中生成两个 pb 文件，类似于
- xxx.pb.go：这个文件中包含所有 protobuf 代码，用于填充、序列化、检索 protobuf 请求和响应消息；
- 另一个 xxx_grpc.pb.go 文件中则包含了一个客户端接口类型，也叫存根，它提供了供用户调用服务中定义方法的能力；还有一个是服务器端接口类型，需要服务器实现，即那些在服务中声明的方法；

## 实现 gRPC server
代码生成完成后，我们就可以创建自定义服务的服务器了，因为现在服务器只是一个抽象接口类型，还没有具体的实现类，所以我们需要定义一个类实现这个接口，在实现服务器端接口方法的过程中，一般会涉及到单一 RPC 方法、服务器端流 RPC 方法、客户端流 RPC 方法以及双向流 RPC 方法，对于特定的流方法需要使用 stream 修饰，并且调用流对象提供的 Send 和 Recv 对消息进行收发；
- 假设我们已经实现了所有方法，那么接下来我们就可以启动一个 gRPC 服务器了，以便客户端可以实际使用我们的服务；
- 而为了创建和启动一个服务器，我们一般需要通过 4 个步骤：

第一步：我们需要指定 gRPC 服务器监听的地址和端口号，这样服务器就能对该端口上的客户端请求进行服务了；第一步结束后，我们可以得到一个监听特定端口请求的连接对象；
第二步：为了提供 gRPC 服务，我们需要创建一个 gRPC 服务实例，当然我们可以对 gRPC 服务实例进行配置，比如是否开启压缩功能；使用指定的配置项调用 `grpc.NewServer(opts...))` 方法创建一个未注册服务的 gRPC 服务实例；
第三步：有了 gRPC 服务实例，我们就可以使用该实例注册我们的服务实现了；具体操作是：调用 pb 包中的服务注册方法，以 gRPC 服务实例和刚才实现了服务端接口的类实例作为参数，将我们实现的服务注册到 gRPC 服务器实例上。
第四步：使用已经注册了我们服务的 gRPC 服务器实例调用 Serve 方法为监听端口的请求提供服务，这个方法是阻塞式的，它会阻塞等待客户端请求的到达，然后对客户端请求进行响应，直至进程被杀死，或者服务端主动调用 Stop() 停止服务。

## 实现 gRPC client
ok，我们已经完成 gRPC 服务的创建和启动；下面我们创建 gRPC 客户端，然后使用客户端对服务器发起 RPC 调用；
1. 要调用服务方法，我们首先要创建一个 gRPC 通道用来和服务器建立通信连接，这可以通过指定服务器的地址和端口号然后调用 `grpc.Dial` 方法来完成；
2. gRPC 通道创建完成后，我们就可以通过和服务器端拥有相同方法的客户端存根执行 RPC，客户端存根可以以 gRPC 通道为参数调用 pb 包中提供的存根初始化函数来获取；一般命名规则是：NewServiceNameClient
3. 有了客户端存根后，我们就可以调用服务方法了；和之前创建具体类实现服务端接口类似，客户端这边的调用方法也分为 4 种，分别是：单一 RPC 方法、服务端流 RPC 方法、客户端流 RPC 方法以及双向流 RPC 方法，这几种调用方法类似但也存在一些差别：
- 比如对于客户端流方法和双向流方法的调用，只需要传入一个上下文对象即可，返回的是一个可读写的流对象；
- 而服务器端流方法由于需要根据客户端请求返回一系列 protobuf 响应，所以调用方除了传递用于控制 RPC 行为的上下文对象外，还需要填充 protobuf 请求消息作为参数供服务端处理；
- 最后，单向 RPC 方法需要提供上下文对象和 protobuf 请求消息作为参数，并在调用没有发生错误时，在第一个返回参数中获取protobuf 响应消息；
- 对于单一 RPC 方法，用户发送一次 RPC 请求，获取一次 RPC 响应；
- 对于服务器端流 RPC 方法，用户发送一个 RPC 请求，获取到一个消息流对象，调用消息流对象的 Recv 函数不断的从服务端读取 protobuf 响应消息，直至读取完毕或者 RPC 调用终止为止。
- 对于客户端流 RPC 方法，用户调用该方法获取一个消息流，然后不断往流对象中发送 RPC 请求，服务器端可以批量处理后或者全部处理完毕后在一个 RPC 响应中返回结果；
- 对于双向流 RPC 方法，用户调用该方法获取一个可读写的消息流，它可以一边往流对象中写入消息，同时也可以从流对象中读取消息，读写流是完全独立的，用户可以以任意顺序对消息流进行读写；

ok，我们已经创建了注册了我们服务的 gRPC 服务实例并成功启动了 gRPC 服务，然后我们通过指定服务器的服务地址和端口号获取用于和服务建立连接的通信对象，然后调用 pb 包中的存根初始化方法获取到拥有和服务器端通信的客户端存根 然后，我们也分析了调用不同类型 RPC 方法需要注意的事项并编写 4 种不同 RPC 方法调用的实例代码；

## RPC Call

现在，我们服务器端和客户端都已经准备好了，我们先启动 gRPC 服务器端，然后在另一个终端上启动 gRPC 客户端，就可以看到，客户端发起 RPC 请求，服务器端进行 RPC 响应；

ok，这就是 RPC 通信开发流程了。

